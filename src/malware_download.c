#include <stdio.h>
#include <Windows.h>
#include <curl/curl.h>

#include "miscellaneous.h"
#include "ansi_colours.h"
#include "malshare.h"

enum api_name {
    UNPAC_ME,
    MALPEDIA,
    MALSHARE,
    HYBRIDANALYSIS,
    DEFAULT
};


BOOL download_malware(char* api_key, char* sample_hash, char* api_name){
    // This function will download the malware sample from the API.
    // The function will return TRUE if the malware sample was downloaded successfully.
    // The function will return FALSE if the malware sample was not downloaded successfully.

    // Check if the parameters are valid
    if (!api_key || !sample_hash || !api_name){
        fprintf(stderr, ANSI_RED"[!] Error: Missing parameters\n" ANSI_RESET);
        return FALSE;
    }
    if (check_api_name(api_name) == FALSE){
        char* api_name = "default";
        printf(ANSI_RED"[!] Warning: No API name provided or isn't amongst available APIs used to download malware, using default API\n" ANSI_RESET);
    }
    if (hash_sample_validation(sample_hash) == FALSE){
        fprintf(stderr, ANSI_RED"[!] Error: Invalid hash. Correct lenghts are 128 || 256.\n" ANSI_RESET);
        return FALSE;
    }

    // Download the malware sample
    switch (api_name){
        case 0:
            BOOL unpac_me_response = download_malware_unpac_me(api_key, sample_hash);
            if (unpac_me_response == FALSE){
                fprintf(stderr, ANSI_RED"[!] Error: Failed to download malware sample from unpac_me\n" ANSI_RESET);
                return FALSE;
            }
        case 1:
            BOOL malpedia_response = download_malware_malpedia(api_key, sample_hash);
            if (malpedia_response == FALSE){
                fprintf(stderr, ANSI_RED"[!] Error: Failed to download malware sample from unpac_me\n" ANSI_RESET);
                return FALSE;
            }
        case 2:
            BOOL malshare_response = download_malware_malshare(api_key, sample_hash);
            if (malshare_response == FALSE){
                fprintf(stderr, ANSI_RED"[!] Error: Failed to download malware sample from unpac_me\n" ANSI_RESET);
                return FALSE;
            }
        case 3:
            BOOL hybridanalysis_response = download_malware_hybridanalysis(api_key, sample_hash);
            if (hybridanalysis_response == FALSE){
                fprintf(stderr, ANSI_RED"[!] Error: Failed to download malware sample from unpac_me\n" ANSI_RESET);
                return FALSE;
            }
        default:
            fprintf(stderr, ANSI_RED"[!] Error: No API name provided or isn't amongst available APIs used to download malware\n" ANSI_RESET);
            return FALSE;
    }



    return FALSE;
}

char* download_malware_query(char* api_key, char* sample_hash){
    // This function will download the malware sample from the API.
    // The function will return what API can be used to download the malware sample.
    // EX return "unpac_me" if the sample can be downloaded from unpac_me.

    char* answer = NULL;

    return answer;
}

BOOL download_malware_check_folder(){
    // This function will check if the folder exists to store the malware samples.
    // If the folder does not exist, the function will create the folder.
}


BOOL download_malware_unpac_me(char* api_key, char* sample_hash){
}

BOOL download_malware_malpedia(char* api_key, char* sample_hash){
}

BOOL download_malware_malshare(char* api_key, char* sample_hash){
    char* malware = malshare_download_file(api_key, sample_hash);
}

BOOL download_malware_hybridanalysis(char* api_key, char* sample_hash){
}
