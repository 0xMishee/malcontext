#include <stdio.h>
#include <cjson/cJSON.h>
#include <curl/curl.h>
#include <windows.h>
#include "miscellaneous.h"
#include "ansi_colours.h"

#include <cjson/cJSON.h>

char* malwarebazaar_check_response_string(char* api_response){
    cJSON* api_response_json = cJSON_Parse(api_response);
    if (api_response_json == NULL) {
        fprintf(stderr, ANSI_RED"[!] Failed to validate Malware Bazaar data.\n"ANSI_RESET);
        return NULL;
    }

    cJSON* api_response_json_answer_string = cJSON_GetArrayItem(api_response_json, 0);
    char* api_response_answer_string = (char*)malloc(strlen(api_response_json_answer_string->valuestring) + 1);
    strcpy_s(api_response_answer_string, strlen(api_response_json_answer_string->valuestring) + 1, api_response_json_answer_string->valuestring);
    
    cJSON_Delete(api_response_json);
    return api_response_answer_string;
}

char* malwarebazaar_search(char* sample_hash){
    CURL *hnd = curl_easy_init();
    api_call_response api_response;

    api_response.data = (char *)malloc(1);
    api_response.size = 0;

    curl_easy_setopt(hnd, CURLOPT_CUSTOMREQUEST, "POST");
    curl_easy_setopt(hnd, CURLOPT_WRITEFUNCTION, write_data_callback);
    curl_easy_setopt(hnd, CURLOPT_WRITEDATA, (void *)&api_response);

    char* api_url_header = "https://mb-api.abuse.ch/api/v1/";
    curl_easy_setopt(hnd, CURLOPT_URL, api_url_header);

    char* sample_hash_header = append_header_strings("query=get_info&hash=%s", sample_hash);
    curl_easy_setopt(hnd, CURLOPT_POSTFIELDS, sample_hash_header);

    CURLcode ret = curl_easy_perform(hnd);
    if(ret != CURLE_OK) {
        fprintf(stderr, ANSI_RED"[!] Failed to perform curl request: %s\n"ANSI_RESET, curl_easy_strerror(ret));
        return NULL;
    };

    curl_easy_cleanup(hnd);
    return api_response.data;
}

BOOL malwarebazaar_download_file(char* sample_hash){
    CURL *hnd = curl_easy_init();

    api_call_response api_response;
    api_response.data = (char *)malloc(1);
    api_response.size = 0;

    curl_easy_setopt(hnd, CURLOPT_CUSTOMREQUEST, "POST");
    curl_easy_setopt(hnd, CURLOPT_WRITEFUNCTION, write_data_callback);
    curl_easy_setopt(hnd, CURLOPT_WRITEDATA, (void *)&api_response);

    char* api_url_header = "https://mb-api.abuse.ch/api/v1/";
    curl_easy_setopt(hnd, CURLOPT_URL, api_url_header);

    char* sample_hash_header = append_header_strings("query=get_file&sha256_hash=%s", sample_hash);
    curl_easy_setopt(hnd, CURLOPT_POSTFIELDS, sample_hash_header);

    CURLcode ret = curl_easy_perform(hnd);
    if(ret != CURLE_OK) {
        fprintf(stderr, ANSI_RED"[!] Failed to perform curl request: %s\n"ANSI_RESET, curl_easy_strerror(ret));
        return FALSE;
    };

    // Check so it's actually valid file data. 
    char* response_string = malwarebazaar_check_response_string(api_response.data);
    if (strcmp(response_string, "file_not_found") == 0) {
        fprintf(stderr, ANSI_RED"[!] File not found for hash: %s\n"ANSI_RESET, sample_hash);
        free(response_string);
        return FALSE;
    }
    free(response_string);

    // Create file, don't like it this way. But can't be bothered atm to understand where I've a nulltermination on the return data.
    char file_name[256];
    if (strcpy_s(file_name, sizeof(file_name), sample_hash) != 0) {
        fprintf(stderr, ANSI_RED"[!] Failed to copy sample hash to file name\n"ANSI_RESET);
        curl_easy_cleanup(hnd);
        free(api_response.data);
        return FALSE;
    }

    if (strcat_s(file_name, sizeof(file_name), ".zip") != 0) {
        fprintf(stderr, ANSI_RED"[!] Failed to append .zip to file name\n"ANSI_RESET);
        curl_easy_cleanup(hnd);
        free(api_response.data);
        return FALSE;
    }

    if (create_file_nsterminated(file_name, api_response.data, api_response.size) != TRUE) {
        fprintf(stderr, ANSI_RED"[!] Failed to create file: %s\n"ANSI_RESET, file_name);
        free(api_response.data);
        curl_easy_cleanup(hnd);
        return FALSE;
    } else {
        printf(ANSI_GREEN"[+] File successfully created and downloaded: %s\n"ANSI_RESET, file_name);
    }

    free(api_response.data);
    curl_easy_cleanup(hnd);
    return TRUE;
}
